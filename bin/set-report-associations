#!/usr/bin/env node

const inflection = require('inflection');
const models = require('../models');

models.sequelize
  .transaction(async (transaction) => {
    const reports = await models.Report.findAll({ transaction });
    for (const report of reports) {
      process.stdout.write('.');
      for (const prefix of ['medication', 'procedure', 'vital', 'file']) {
        const ids = report[`${prefix}Ids`];
        if (ids) {
          // eslint-disable-next-line no-await-in-loop
          await report[`set${inflection.capitalize(prefix)}s`](ids, { transaction });
        }
      }
    }
    process.stdout.write(' Done!\n');
  })
  .then(() => {
    models.sequelize.close();
    process.exit(0);
  });
